<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹¼å›¾æ¸¸æˆ - ç®¡ç†å‘˜ç«¯</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        .upload-area:hover {
            background: #f0f4ff;
        }

        .upload-area.dragover {
            background: #e0e7ff;
            border-color: #764ba2;
        }

        #imagePreview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            display: none;
            margin: 15px 0;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(86, 171, 47, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f85032 0%, #e73827 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(248, 80, 50, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .qr-code-container {
            text-align: center;
        }

        #qrCode {
            margin: 15px 0;
        }

        #qrCode img {
            max-width: 200px;
            border: 5px solid white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .player-count {
            text-align: center;
            font-size: 1.2rem;
            color: #667eea;
            margin-top: 15px;
        }

        .leaderboard {
            grid-column: 1 / -1;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-table th,
        .leaderboard-table td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .leaderboard-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
        }

        .leaderboard-table tr:hover {
            background: #f0f4ff;
        }

        .rank {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .rank-1 { color: #FFD700; }
        .rank-2 { color: #C0C0C0; }
        .rank-3 { color: #CD7F32; }

        .medal {
            display: inline-block;
            width: 30px;
            height: 30px;
            line-height: 30px;
            border-radius: 50%;
            font-size: 1.2rem;
        }

        .medal-gold { background: #FFD700; color: white; }
        .medal-silver { background: #C0C0C0; color: white; }
        .medal-bronze { background: #CD7F32; color: white; }

        .status-badge {
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .status-joined {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-playing {
            background: #fff3e0;
            color: #f57c00;
        }

        .status-finished {
            background: #e8f5e9;
            color: #388e3c;
        }

        .game-status {
            text-align: center;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .status-waiting { background: #e3f2fd; color: #1976d2; }
        .status-playing { background: #fff3e0; color: #f57c00; }
        .status-finished { background: #e8f5e9; color: #388e3c; }

        .control-row {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }

        .difficulty-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .difficulty-selector label {
            font-weight: bold;
            color: #667eea;
        }

        .difficulty-select {
            padding: 8px 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .difficulty-select:hover {
            border-color: #764ba2;
            background: #f0f4ff;
        }

        .difficulty-select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .leaderboard-table {
                font-size: 0.9rem;
            }

            .leaderboard-table th,
            .leaderboard-table td {
                padding: 10px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§© æ‹¼å›¾æ¸¸æˆ - ç®¡ç†å‘˜ç«¯</h1>
        </div>

        <div class="main-content">
            <div class="card">
                <h2>ğŸ“¤ ä¸Šä¼ å›¾ç‰‡</h2>
                <div class="upload-area" id="uploadArea">
                    <p>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</p>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;">
                </div>
                <img id="imagePreview" alt="é¢„è§ˆ">
            </div>

            <div class="card">
                <h2>ğŸ“± ç©å®¶æ‰«ç åŠ å…¥</h2>
                <div class="qr-code-container">
                    <div id="qrCode">åŠ è½½ä¸­...</div>
                    <div class="player-count">
                        å·²åŠ å…¥ç©å®¶: <strong id="playerCount">0</strong>
                    </div>
                </div>
            </div>
        </div>

        <div class="card" style="margin-bottom: 20px;">
            <div class="game-status status-waiting" id="gameStatus">
                æ¸¸æˆçŠ¶æ€: ç­‰å¾…å¼€å§‹
            </div>
            <div class="control-row">
                <div class="difficulty-selector">
                    <label for="difficultySelect">éš¾åº¦é€‰æ‹©:</label>
                    <select id="difficultySelect" class="difficulty-select">
                        <option value="3">ç®€å• (3x3)</option>
                        <option value="4">ä¸­ç­‰ (4x4)</option>
                        <option value="5">å›°éš¾ (5x5)</option>
                    </select>
                </div>
            </div>
            <div class="button-group">
                <button class="btn btn-success" id="startBtn" disabled>å¼€å§‹æ¸¸æˆ</button>
                <button class="btn btn-danger" id="resetBtn">é‡ç½®æ¸¸æˆ</button>
            </div>
        </div>

        <div class="card leaderboard">
            <h2>ğŸ† å®æ—¶æ’è¡Œæ¦œ</h2>
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th>æ’å</th>
                        <th>ç©å®¶åç§°</th>
                        <th>çŠ¶æ€</th>
                        <th>ç”¨æ—¶</th>
                        <th>æ­¥æ•°</th>
                    </tr>
                </thead>
                <tbody id="leaderboardBody">
                    <tr>
                        <td colspan="5">æš‚æ— ç©å®¶</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${wsProtocol}//${window.location.host}`);
        let currentImage = null;

        // DOM å…ƒç´ 
        const uploadArea = document.getElementById('uploadArea');
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');
        const qrCodeDiv = document.getElementById('qrCode');
        const playerCountSpan = document.getElementById('playerCount');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const gameStatusDiv = document.getElementById('gameStatus');
        const leaderboardBody = document.getElementById('leaderboardBody');

        // ä¸Šä¼ åŒºåŸŸç‚¹å‡»
        uploadArea.addEventListener('click', () => imageInput.click());

        // æ‹–æ‹½ä¸Šä¼ 
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                handleImageUpload(file);
            }
        });

        // æ–‡ä»¶é€‰æ‹©
        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleImageUpload(file);
            }
        });

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        function handleImageUpload(file) {
            // å…ˆå‹ç¼©å›¾ç‰‡
            compressImage(file, 800, 0.8).then(compressedFile => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentImage = e.target.result;
                    imagePreview.src = currentImage;
                    imagePreview.style.display = 'block';
                    uploadToServer(compressedFile);
                };
                reader.readAsDataURL(compressedFile);
            });
        }

        // å‹ç¼©å›¾ç‰‡
        function compressImage(file, maxWidth, quality) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // æŒ‰æ¯”ä¾‹ç¼©æ”¾
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            resolve(new File([blob], file.name, {
                                type: 'image/jpeg',
                                lastModified: Date.now()
                            }));
                        }, 'image/jpeg', quality);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // ä¸Šä¼ åˆ°æœåŠ¡å™¨
        async function uploadToServer(file) {
            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                // å‘é€å›¾ç‰‡æ›´æ–°æ¶ˆæ¯
                ws.send(JSON.stringify({
                    type: 'uploadImage',
                    imageData: currentImage,
                    filename: data.filename
                }));

                startBtn.disabled = false;
            } catch (error) {
                console.error('Upload error:', error);
                alert('ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // å¼€å§‹æ¸¸æˆ
        startBtn.addEventListener('click', () => {
            const gridSize = parseInt(document.getElementById('difficultySelect').value);
            ws.send(JSON.stringify({
                type: 'startGame',
                gridSize: gridSize
            }));
            startBtn.disabled = true;
        });

        // é‡ç½®æ¸¸æˆ
        resetBtn.addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦é‡ç½®æ¸¸æˆå—ï¼Ÿ')) {
                ws.send(JSON.stringify({ type: 'resetGame' }));
                currentImage = null;
                imagePreview.style.display = 'none';
                imagePreview.src = '';
                startBtn.disabled = true;
            }
        });

        // WebSocket æ¶ˆæ¯å¤„ç†
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);

            switch (data.type) {
                case 'leaderboard':
                    updateLeaderboard(data.players);
                    playerCountSpan.textContent = data.players.length;
                    break;

                case 'gameStart':
                    gameStatusDiv.textContent = 'æ¸¸æˆçŠ¶æ€: è¿›è¡Œä¸­';
                    gameStatusDiv.className = 'game-status status-playing';
                    break;

                case 'gameEnd':
                    gameStatusDiv.textContent = 'æ¸¸æˆçŠ¶æ€: å·²ç»“æŸ';
                    gameStatusDiv.className = 'game-status status-finished';
                    startBtn.disabled = true;
                    break;

                case 'gameReset':
                    gameStatusDiv.textContent = 'æ¸¸æˆçŠ¶æ€: ç­‰å¾…å¼€å§‹';
                    gameStatusDiv.className = 'game-status status-waiting';
                    startBtn.disabled = true;
                    updateLeaderboard([]);
                    playerCountSpan.textContent = '0';
                    break;
            }
        };

        // æ›´æ–°æ’è¡Œæ¦œ
        function updateLeaderboard(players) {
            if (players.length === 0) {
                leaderboardBody.innerHTML = '<tr><td colspan="5">æš‚æ— ç©å®¶</td></tr>';
                return;
            }

            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];

            leaderboardBody.innerHTML = players.map((player, index) => {
                const rankDisplay = index < 3
                    ? `<span class="rank rank-${index + 1}">${medals[index]}</span>`
                    : `<span class="rank">${index + 1}</span>`;

                const statusClass = `status-${player.status}`;
                const statusText = {
                    'joined': 'å·²åŠ å…¥',
                    'playing': 'æ¸¸æˆä¸­',
                    'finished': 'å·²å®Œæˆ'
                }[player.status] || player.status;

                const timeDisplay = player.status === 'finished'
                    ? formatTime(player.time)
                    : '-';

                return `
                    <tr>
                        <td>${rankDisplay}</td>
                        <td>${player.name}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${timeDisplay}</td>
                        <td>${player.steps}</td>
                    </tr>
                `;
            }).join('');
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // åŠ è½½äºŒç»´ç 
        loadQRCode();

        async function loadQRCode() {
            try {
                const response = await fetch('/qrcode');
                const data = await response.json();
                qrCodeDiv.innerHTML = `<img src="${data.qrCode}" alt="æ‰«ç åŠ å…¥æ¸¸æˆ">`;
            } catch (error) {
                console.error('Failed to load QR code:', error);
                qrCodeDiv.textContent = 'äºŒç»´ç åŠ è½½å¤±è´¥';
            }
        }

        ws.onclose = () => {
            console.log('WebSocket disconnected');
            setTimeout(() => location.reload(), 3000);
        };

        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
        };
    </script>
</body>
</html>
