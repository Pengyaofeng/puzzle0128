<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>拼图游戏 - 玩家端</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            padding-top: max(15px, env(safe-area-inset-top));
            padding-bottom: max(15px, env(safe-area-inset-bottom));
            touch-action: manipulation;
            -webkit-overflow-scrolling: touch;
        }

        html {
            height: 100%;
            height: -webkit-fill-available;
        }

        .container {
            width: 100%;
            max-width: 400px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 15px;
        }

        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .player-name {
            font-size: 1rem;
            opacity: 0.9;
        }

        .status-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            -webkit-box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .stats {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-justify-content: space-around;
            justify-content: space-around;
            text-align: center;
        }

        .stat-item {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-flex-direction: column;
            flex-direction: column;
            -webkit-align-items: center;
            align-items: center;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #667eea;
        }

        .game-status {
            text-align: center;
            padding: 10px;
            border-radius: 10px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .status-waiting {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-playing {
            background: #fff3e0;
            color: #f57c00;
        }

        .status-finished {
            background: #e8f5e9;
            color: #388e3c;
        }

        .puzzle-container {
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            -webkit-box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin-bottom: 15px;
        }

        .puzzle-board {
            display: -webkit-box;
            display: -ms-grid;
            display: grid;
            -ms-grid-columns: 1fr 3px 1fr 3px 1fr;
            grid-template-columns: repeat(3, 1fr);
            gap: 3px;
            background: #ddd;
            padding: 3px;
            border-radius: 10px;
            width: 100%;
            padding-bottom: 100%;
            height: 0;
            position: relative;
            overflow: hidden;
        }

        .puzzle-board-inner {
            position: absolute;
            top: 3px;
            left: 3px;
            right: 3px;
            bottom: 3px;
            display: -webkit-box;
            display: -ms-grid;
            display: grid;
            -ms-grid-columns: 1fr 3px 1fr 3px 1fr;
            grid-template-columns: repeat(3, 1fr);
            gap: 3px;
        }

        .puzzle-tile {
            background-size: 300% 300%;
            cursor: pointer;
            border-radius: 5px;
            transition: -webkit-transform 0.2s ease-in-out;
            transition: transform 0.2s ease-in-out;
            position: relative;
            overflow: hidden;
            width: 100%;
            padding-bottom: 100%;
            height: 0;
        }

        .puzzle-tile-inner {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: 300% 300%;
            border-radius: 5px;
            transition: -webkit-transform 0.2s ease-in-out;
            transition: transform 0.2s ease-in-out;
        }

        .puzzle-tile:active {
            -webkit-transform: scale(0.95);
            transform: scale(0.95);
        }

        .preview-container {
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            -webkit-box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin-bottom: 15px;
        }

        .preview-container h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .preview-image {
            width: 100%;
            border-radius: 10px;
            display: block;
            transition: opacity 0.3s ease-in-out;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .waiting-message {
            text-align: center;
            color: white;
            padding: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
        }

        .waiting-message h2 {
            margin-bottom: 10px;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #f00;
            position: absolute;
            -webkit-animation: confetti-fall 3s linear forwards;
            animation: confetti-fall 3s linear forwards;
        }

        @-webkit-keyframes confetti-fall {
            to {
                -webkit-transform: translateY(100vh) rotate(720deg);
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        @keyframes confetti-fall {
            to {
                -webkit-transform: translateY(100vh) rotate(720deg);
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .win-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-align-items: center;
            align-items: center;
            -webkit-justify-content: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top));
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }

        .win-message {
            background: white;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            -webkit-animation: bounce-in 0.5s;
            animation: bounce-in 0.5s;
            max-width: 350px;
            width: 100%;
        }

        @-webkit-keyframes bounce-in {
            0% { -webkit-transform: scale(0); transform: scale(0); }
            50% { -webkit-transform: scale(1.1); transform: scale(1.1); }
            100% { -webkit-transform: scale(1); transform: scale(1); }
        }

        @keyframes bounce-in {
            0% { -webkit-transform: scale(0); transform: scale(0); }
            50% { -webkit-transform: scale(1.1); transform: scale(1.1); }
            100% { -webkit-transform: scale(1); transform: scale(1); }
        }

        .win-message h2 {
            font-size: 1.8rem;
            color: #667eea;
            margin-bottom: 15px;
        }

        .win-stats {
            margin: 20px 0;
        }

        .win-stats p {
            font-size: 1.2rem;
            margin: 10px 0;
            color: #333;
        }

        .close-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: bold;
            -webkit-appearance: none;
            appearance: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>拼图游戏</h1>
            <div class="player-name" id="playerName">加载中...</div>
        </div>

        <div class="game-status status-waiting" id="gameStatus">
            等待游戏开始
        </div>

        <div class="status-card">
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-label">时间</div>
                    <div class="stat-value" id="timer">0:00</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">步数</div>
                    <div class="stat-value" id="moves">0</div>
                </div>
            </div>
        </div>

        <div class="puzzle-container" id="puzzleContainer" style="display: none;">
            <div class="puzzle-board">
                <div class="puzzle-board-inner" id="puzzleBoard"></div>
            </div>
        </div>

        <div class="preview-container" id="previewContainer" style="display: none;">
            <h3>参考图片</h3>
            <img class="preview-image" id="previewImage" alt="参考图">
        </div>

        <div class="waiting-message" id="waitingMessage">
            <h2>等待管理员上传图片并开始游戏</h2>
            <p>请保持页面打开...</p>
        </div>
    </div>

    <script>
        let ws;
        let playerId = null;
        let playerName = null;
        let puzzle = [];
        let gridSize = 3; // 默认 3x3
        let imageUrl = null;
        let moves = 0;
        let startTime = null;
        let timerInterval = null;

        const playerNameEl = document.getElementById('playerName');
        const gameStatusEl = document.getElementById('gameStatus');
        const timerEl = document.getElementById('timer');
        const movesEl = document.getElementById('moves');
        const puzzleContainer = document.getElementById('puzzleContainer');
        const puzzleBoard = document.getElementById('puzzleBoard');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');
        const waitingMessage = document.getElementById('waitingMessage');

        // 连接 WebSocket
        function connect() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${wsProtocol}//${window.location.host}?player=true`);

            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                } catch (e) {
                    console.error('Message parse error:', e);
                }
            };

            ws.onclose = function() {
                console.log('Disconnected, reconnecting...');
                setTimeout(connect, 3000);
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }

        // 处理消息
        function handleMessage(data) {
            switch (data.type) {
                case 'init':
                    playerId = data.playerId;
                    playerName = data.playerName;
                    imageUrl = data.imageUrl;
                    gridSize = data.gridSize || 3;
                    puzzle = data.puzzle || Array(gridSize * gridSize).fill(0);
                    playerNameEl.textContent = playerName;
                    updateGameStatus(data.gameStatus);
                    break;

                case 'imageUpdate':
                    imageUrl = data.imageUrl;
                    // 显示加载状态
                    previewContainer.style.display = 'block';
                    previewImage.style.opacity = '0.5';
                    previewImage.alt = '图片加载中...';
                    // 预加载图片
                    const tempImg = new Image();
                    tempImg.onload = () => {
                        previewImage.src = imageUrl;
                        previewImage.style.opacity = '1';
                        previewImage.alt = '参考图片';
                    };
                    tempImg.src = imageUrl;
                    break;

                case 'puzzleUpdate':
                    if (data.gridSize) gridSize = data.gridSize;
                    puzzle = data.puzzle;
                    renderPuzzle();
                    break;

                case 'gameStart':
                    if (data.gridSize) gridSize = data.gridSize;
                    startGame();
                    break;

                case 'gameReset':
                    resetGame();
                    break;
            }
        }

        // 更新游戏状态
        function updateGameStatus(status) {
            switch (status) {
                case 'waiting':
                    gameStatusEl.textContent = '等待开始';
                    gameStatusEl.className = 'game-status status-waiting';
                    break;
                case 'playing':
                    gameStatusEl.textContent = '游戏中';
                    gameStatusEl.className = 'game-status status-playing';
                    waitingMessage.style.display = 'none';
                    puzzleContainer.style.display = 'block';
                    if (imageUrl) {
                        previewContainer.style.display = 'block';
                        previewImage.src = imageUrl;
                    }
                    renderPuzzle();
                    break;
                case 'finished':
                    gameStatusEl.textContent = '已完成';
                    gameStatusEl.className = 'game-status status-finished';
                    break;
            }
        }

        // 开始游戏
        function startGame() {
            updateGameStatus('playing');
            startTime = Date.now();
            moves = 0;
            movesEl.textContent = '0';
            startTimer();
        }

        // 启动计时器
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(function() {
                const elapsed = Date.now() - startTime;
                const seconds = Math.floor(elapsed / 1000);
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                timerEl.textContent = minutes + ':' + (remainingSeconds < 10 ? '0' : '') + remainingSeconds;
            }, 100);
        }

        // 停止计时器
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        // 重置游戏
        function resetGame() {
            stopTimer();
            moves = 0;
            movesEl.textContent = '0';
            timerEl.textContent = '0:00';
            updateGameStatus('waiting');
            waitingMessage.style.display = 'block';
            puzzleContainer.style.display = 'none';
            previewContainer.style.display = 'none';

            // 移除胜利弹窗
            const overlay = document.querySelector('.win-overlay');
            if (overlay) overlay.remove();
        }

        // 渲染拼图
        function renderPuzzle() {
            if (!imageUrl) return;

            // 更新网格列数
            puzzleBoard.style.gridTemplateColumns = 'repeat(' + gridSize + ', 1fr)';

            puzzleBoard.innerHTML = '';

            puzzle.forEach(function(rotation, index) {
                const tileEl = document.createElement('div');
                tileEl.className = 'puzzle-tile';

                // 计算这个位置对应的图片区域
                const row = Math.floor(index / gridSize);
                const col = index % gridSize;

                const inner = document.createElement('div');
                inner.className = 'puzzle-tile-inner';
                inner.style.backgroundImage = 'url(' + imageUrl + ')';
                // 计算背景位置百分比
                const percent = 100 / (gridSize - 1);
                inner.style.backgroundPosition = (col * percent) + '% ' + (row * percent) + '%';
                inner.style.backgroundSize = (gridSize * 100) + '%';
                inner.style.transform = 'rotate(' + (rotation * 90) + 'deg)';

                tileEl.appendChild(inner);

                tileEl.addEventListener('click', function() {
                    rotateTile(index);
                });

                puzzleBoard.appendChild(tileEl);
            });
        }

        // 旋转拼图块
        function rotateTile(index) {
            // 顺时针旋转90度
            puzzle[index] = (puzzle[index] + 1) % 4;
            moves++;
            movesEl.textContent = moves;

            // 发送旋转操作
            ws.send(JSON.stringify({
                type: 'rotate',
                playerId: playerId,
                tileIndex: index
            }));

            renderPuzzle();

            // 检查是否完成
            if (checkWin()) {
                onWin();
            }
        }

        // 检查是否获胜
        function checkWin() {
            // 所有格子都是0度即为完成
            return puzzle.every(function(val) {
                return val === 0;
            });
        }

        // 获胜处理
        function onWin() {
            stopTimer();
            updateGameStatus('finished');
            createConfetti();

            const elapsed = Date.now() - startTime;
            const seconds = Math.floor(elapsed / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            const timeStr = minutes + ':' + (remainingSeconds < 10 ? '0' : '') + remainingSeconds;

            const overlay = document.createElement('div');
            overlay.className = 'win-overlay';
            overlay.innerHTML =
                '<div class="win-message">' +
                    '<h2>恭喜完成!</h2>' +
                    '<div class="win-stats">' +
                        '<p>用时: ' + timeStr + '</p>' +
                        '<p>步数: ' + moves + '</p>' +
                    '</div>' +
                    '<button class="close-btn" onclick="this.parentElement.parentElement.remove()">关闭</button>' +
                '</div>';
            document.body.appendChild(overlay);
        }

        // 创建彩带效果
        function createConfetti() {
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
            for (let i = 0; i < 50; i++) {
                (function() {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.top = '-10px';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    document.body.appendChild(confetti);

                    setTimeout(function() {
                        confetti.remove();
                    }, 5000);
                })();
            }
        }

        // 初始化连接
        connect();
    </script>
</body>
</html>
